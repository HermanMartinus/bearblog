{% extends 'base.html' %}
{% load humanize %}

{% block title %}Analytics | Bear Blog{% endblock %}

{% block custom_styles %}
    {% include 'styles/blog/default.css' %}
    {% include 'styles/dashboard.css' %}
    {% if not public %}
    {{ request.user.settings.dashboard_styles | safe }}
    {% endif %}
{% endblock %}

{% block nav %}
{% if not public %}
{% include '../snippets/dashboard_nav.html' %}
{% endif %}
{% endblock %}

{% block content %}
<h1>Analytics{% if public %} for {{ blog.title }}{% endif %}</h1>
<p>
    <b>Reading now:</b> {{ on_site|intcomma }}
    
</p>
<div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
    <small>
        Displaying the past {{ days_filter }} days
    </small>
    <span>
        <button onclick="window.location = '?days=7{% if post_filter %}&post={{post_filter}}{% endif %}{% if referrer_filter %}&referrer={{referrer_filter}}{% endif %}'">Last week</button>
        <button onclick="window.location = '?days=30{% if post_filter %}&post={{post_filter}}{% endif %}{% if referrer_filter %}&referrer={{referrer_filter}}{% endif %}'">Last month</button>
        <button onclick="window.location = '?days=90{% if post_filter %}&post={{post_filter}}{% endif %}{% if referrer_filter %}&referrer={{referrer_filter}}{% endif %}'">Last 3 months</button>
        <button onclick="window.location = '?days=180{% if post_filter %}&post={{post_filter}}{% endif %}{% if referrer_filter %}&referrer={{referrer_filter}}{% endif %}'">Last 6 months</button>
        <button onclick="window.location = '?days=365{% if post_filter %}&post={{post_filter}}{% endif %}{% if referrer_filter %}&referrer={{referrer_filter}}{% endif %}'">Last year</button>
        <button onclick="window.location = '?days=99999{% if post_filter %}&post={{post_filter}}{% endif %}{% if referrer_filter %}&referrer={{referrer_filter}}{% endif %}'">All time</button>
    </span>
</div>

<canvas id="hitsChart" height="200"></canvas>
<span class="helptext" style="display: flex; justify-content:space-between;">
    <span>{{ start_date|date:"j F Y" }}</span>
    <span>{{ end_date|date:"j F Y" }}</span>
</span>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('hitsChart').getContext('2d');
    const chartData = {{ chart_data|safe }};
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: chartData.map(item => item.date.split('-')[2]),
            datasets: [{
                label: 'Reads',
                data: chartData.map(item => item.hits),
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: {
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        fetch('/{{ blog.subdomain }}/dashboard/analytics/data/?days={{ days_filter }}{% if post_filter %}&post={{ post_filter }}{% endif %}')
            .then(response => response.json())
            .then(data => {
                // Update unique reads and visitors
                document.getElementById('unique-reads').textContent = data.unique_reads.toLocaleString();
                document.getElementById('unique-visitors').textContent = data.unique_visitors.toLocaleString();
                
                // Update posts list
                const postsList = document.getElementById('posts-list');
                data.posts.forEach(post => {
                    const li = document.createElement('li');
                    li.style.cssText = 'display:flex;justify-content:space-between;padding:5px 0;';
                    li.innerHTML = `
                        <span>
                            ${post.hit_count > 0 ? 
                                `<a href="?days={{ days_filter }}&post=${post.slug}{% if referrer_filter %}&referrer={{ referrer_filter }}{% endif %}">${post.title}</a>` : 
                                post.title}
                            <small>(▵${post.upvotes})</small>
                            <a href="{{ blog.dynamic_useful_domain }}/${post.slug}" target="_blank">↪</a>
                        </span>
                        <span>${post.hit_count.toLocaleString()}</span>
                    `;
                    postsList.appendChild(li);
                });
                
                // Update referrers list
                const referrersList = document.getElementById('referrers-list');
                data.referrers.forEach(referrer => {
                    const li = document.createElement('li');
                    li.style.cssText = 'display:flex;justify-content:space-between;padding:5px 0;';
                    li.innerHTML = `
                        <span>
                            <a href="?days={{ days_filter }}&referrer=${encodeURIComponent(referrer.referrer)}{% if post_filter %}&post={{ post_filter }}{% endif %}">${referrer.referrer}</a>
                            <a href="${encodeURIComponent(referrer.referrer)}" target="_blank">↪</a>
                        </span>
                        <span>${referrer.count ? referrer.count.toLocaleString() : '0'}</span>
                    `;
                    referrersList.appendChild(li);
                });
                
                // Update devices list
                const devicesList = document.getElementById('devices-list');
                data.devices.forEach(device => {
                    const li = document.createElement('li');
                    li.style.cssText = 'display:flex;justify-content:space-between;padding:5px 0;';
                    li.innerHTML = `
                        ${device.device}
                        <span>${device.count.toLocaleString()}</span>
                    `;
                    devicesList.appendChild(li);
                });
                
                // Update browsers list
                const browsersList = document.getElementById('browsers-list');
                data.browsers.forEach(browser => {
                    const li = document.createElement('li');
                    li.style.cssText = 'display:flex;justify-content:space-between;padding:5px 0;';
                    li.innerHTML = `
                        ${browser.browser}
                        <span>${browser.count.toLocaleString()}</span>
                    `;
                    browsersList.appendChild(li);
                });
                
                // Update countries list
                const countriesList = document.getElementById('countries-list');
                data.countries.forEach(country => {
                    const li = document.createElement('li');
                    li.style.cssText = 'display:flex;justify-content:space-between;padding:5px 0;';
                    li.innerHTML = `
                        ${country.country}
                        <span>${country.count.toLocaleString()}</span>
                    `;
                    countriesList.appendChild(li);
                });
            });
    });
</script>

<p>
    <b>Unique reads:</b> <span id="unique-reads">Loading...</span>
    <br>
    <b>Unique visitors:</b> ~<span id="unique-visitors">Loading...</span>
<p>
{% if post_filter %}
    <small>Post: <b>{{ posts.first.title }}</b></small>
    <a href="?days={{days_filter}}{% if referrer_filter %}&referrer={{referrer_filter}}{% endif %}"><button>Remove filter</button></a>
    <br>
{% endif %}
{% if referrer_filter %}
    <small>Referrer: <b>{{ referrer_filter }}</b></small>
    <a href="?days={{days_filter}}{% if post_filter %}&post={{post_filter}}{% endif %}"><button>Remove filter</button></a>
{% endif %}
</p>

<div style="display:flex;flex-flow:row wrap;justify-content:space-between; font-size: 12px;">
    <div style="width: 340px">
    <h3>Pages</h3>
        <ul id="posts-list" style="padding: 0; max-height: 300px; overflow-y: auto;"></ul>
    </div>
    <div style="width: 340px">
        <h3>Referrers</h3>
        <ul id="referrers-list" style="padding: 0;max-height: 300px;overflow-y: auto;word-break:break-all;">
        </ul>
    </div>
</div>

<div style="padding-top:20px;display:flex; flex-flow: row wrap;justify-content:space-between; font-size: 12px;">
    <div style="width:220px">
        <h3>Devices</h3>
        <ul id="devices-list" style="padding: 0;max-height: 300px;overflow-y: auto">
        </ul>
    </div>
    <div style="width:220px">
        <h3>Browsers</h3>
        <ul id="browsers-list" style="padding: 0;max-height: 300px;overflow-y: auto">
        </ul>
    </div>
    <div style="width:220px">
        <h3>Countries</h3>
        <ul id="countries-list" style="padding: 0;max-height: 300px;overflow-y: auto">
        </ul>
    </div>
</div>
{% endblock %}


{% block footer %}
{% if public %}
Powered by <a href="https://bearblog.dev">Bear ʕ•ᴥ•ʔ</a>
{% else %}
{% include 'snippets/dashboard_footer.html' %}
{% endif %}
{% endblock %}
