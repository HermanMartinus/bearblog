{% extends 'base.html' %}
{% load pygmentify_tags %}
{% load custom_tags %}

{% block page_type %}{% if post.is_page %}page{% else %}post{% endif %} {{ post.class_name }}{% endblock %}

{% block lang %}{% if post.lang %}{{ post.lang }}{% else %}{{ blog.lang }}{% endif %}{% endblock %}

{% block favicon %}{% include 'snippets/favicon.html' with blog=blog %}{% endblock %}

{% block title %}{{ post.title }} | {{ blog.title }}{% endblock %}

{% block canonical %}<link rel="canonical" href="{{ canonical_url }}">{% endblock %}

{% block seo %}
    {% if not blog.reviewed %}<meta name="robots" content="noindex, nofollow">{% endif %}

    <meta name="{{ blog.subdomain }}" content="look-for-the-bear-necessities">

    {% include 'snippets/seo_tags.html' with site_name=blog.title title=post.title type="article" url=full_path description=meta_description image=meta_image meta_tag=blog.meta_tag %}
    <link rel="alternate" type="application/atom+xml" href="/feed/" title="{{ blog.title }}">
    <link rel="alternate" type="application/rss+xml" href="/feed/?type=rss" title="{{ blog.title }}">
{% endblock %}

{% block imports %}
    {% if blog.user.settings.upgraded %}{{ blog.header_directive | safe }}{% endif %}

    {% if blog.fathom_site_id %}<script src="https://cdn.usefathom.com/script.js" data-site="{{ blog.fathom_site_id }}" defer></script>{% endif %}
    {% if post.contains_code %}<link rel="stylesheet" href="{% pygmentify_css minify='false' %}">{% endif %}
{% endblock %}

{% block custom_styles %}
    {% include 'snippets/styles.html' with blog=blog %}
    .upvote-button {
        padding: 0;
        margin: 0;
        border: 0;
        background-color: inherit;
        color: inherit;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .upvote-button.upvoted {
        color: salmon;
    }
    .upvote-count {
        margin-top: -3px;
    }
{% endblock %}

{% block heading %}{{ blog.title }}{% endblock %}

{% block nav %}{% markdown content=blog.nav blog=blog post=post tz=tz %}{% endblock %}

{% block content %}

    {% if preview %}
        <p style="width:100%;padding:10px;background-color:lightsalmon;color:white;display:flex;justify-content:space-between;line-height:15px;">
            PREVIEW
                {% if error_message %}<span>{{ error_message }}</span>{% endif %}
            <small>
                Close and re-open to refresh
            </small>
        </p>
    {% endif %}

    {% if not post.is_page %}
        <h1>{{ post.title }}</h1>

        <p>
            <i>
                {% include './snippets/formatted_date.html' with date=post.published_date %}
            </i>
        </p>
    {% endif %}

    {% markdown content=post.content blog=blog post=post tz=tz %}

    {% if canonical_url != full_path %}
        <p>
            <small>
                <a href="{{ canonical_url }}">View original</a>
            </small>
        </p>
    {% endif %}

    {% if not preview %}
        {% if post.tags|length > 0 %}
            <p class="tags">
                <a rel="nofollow" href="/{{ blog.blog_path }}/?q=pot-of-honey" style="display:none;">#potofhoney</a>
                {% for tag in post.tags %}
                    <a rel="nofollow" href="/{{ blog.blog_path }}/?q={{tag}}">#{{ tag }}</a>
                {% endfor %}
            </p>
        {% endif %}

        {% if post.make_discoverable %}
            {% include 'snippets/upvote_form.html' with post=post upvoted=upvoted %}
        {% endif %}

        {% if blog.analytics_active %}
            <script>
            window.addEventListener("load", () => {
                if (navigator.webdriver !== true) {
                    const sendHit = score => {
                        const params = new URLSearchParams({
                            blog: "{{ blog.subdomain }}",
                            token: "{{ post.uid }}",
                            referrer: document.referrer.includes("{{ blog.blank_useful_domain }}") ? "" : document.referrer,
                            title: "",
                            score: score
                        });
                        new Image().src = `/hit/?${params.toString()}`;
                    };

                    document.addEventListener('touchmove', () => sendHit(100), { once: true });
                    document.addEventListener('mousemove', () => sendHit(100), { once: true });
                }
            });
            </script>
        {% endif %}
    {% endif %}

{% endblock %}


{% block footer %}
    {% if blog.user.settings.upgraded and blog.footer_directive %}
        <span id="footer-directive">
            {% markdown content=blog.footer_directive blog=blog post=post tz=tz %}
        </span>
    {% endif %}
    <span>
        Powered by <a href="https://bearblog.dev">Bear <span role="img" class="bear" aria-label="ASCII bear logo">ʕ•ᴥ•ʔ</span></a>
    </span>
{% endblock %}